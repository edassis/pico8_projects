pico-8 cartridge // http://www.pico-8.com
version 33
__lua__

s_wall = 1

p = {
  x = 60,
  y = 60,
  w = 8,
  h = 8,
  acc = 3,
  life = 3,
  frame = 2,
}

keys = {
  left = 0,
  right = 1,
  up = 2,
  down = 3,
}

dirs = {
  [keys.left] = {x=-1, y=0},
  [keys.right] = {x=1, y=0},
  [keys.up] = {x=0, y=-1},
  [keys.down] = {x=0, y=1},
}

-- ############################

function draw_p()
  spr(p.frame, (p.x), (p.y))
end

function move_p()
  local mv = {x = 0, y = 0}

  if (btn(keys.left)) mv.x-=1
  if (btn(keys.right)) mv.x+=1
  if (btn(keys.up)) mv.y-=1
  if (btn(keys.down)) mv.y+=1
  
  if mv.x != 0 or
      mv.y != 0 then 

    local ang = atan2(mv.x,
      mv.y)
    
    -- rotating acc by angle
    p.x = p.x +
      flr(abs(p.acc * cos(ang)))
      * sgn(mv.x)

    p.y = p.y +
      flr(abs(p.acc * sin(ang)))
      * sgn(mv.y)
  end
end

function collision_p()
  local cell = {}
  cell.size = 8
  -- checks all directions
  -- around the player
  for k,dir in pairs(dirs) do
    local offset = 
      {x = flr(p.w/2),
       y = flr(p.h/2)}
       
    local collided = false
       
    repeat 
      collided = false

      local center = 
        {x = p.x + offset.x, 
          y = p.y + offset.y}
      
      cell.x = (center.x +
        offset.x*dir.x)/
        cell.size

      cell.y = (center.y +
        offset.y*dir.y)/
        cell.size

      -- even-sized array has
      -- no median. So, we must
      -- set an upper limit
      x_max = p.x+p.w-1
      y_max = p.y+p.h-1

      cell.x = 
        min(x_max/cell.size,
        cell.x)

      cell.y = 
        min(y_max/cell.size,
        cell.y)
      
      if mget(cell.x,cell.y)
          == s_wall then
        p.x -= dir.x 
        p.y -= dir.y 
        collided = true
      end

    until not collided
  end
end

-- ############################

log = { msgs = {} }
function log:push(str)
  add(self.msgs, str)
end

function log:show()
  color(7)
  cursor(20,20)
  for v in all(self.msgs) do
    print(v)
  end
  log.msgs = {}
end

-- ############################

function _init()
end
 
function _update()
  move_p()
  collision_p()
end
 
function _draw()
  cls()
  map(0,0,0,0,16,16)
  draw_p()
  
  -- overlay
  print('duds',1,122,11)
  log:show()
end

__gfx__
00000000777777779998899900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777779004400900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777779444444900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777779404404900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777779004400900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777779044440900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777779040040900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
00000000777777779949949900000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001000000000000000000000000010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0001010101010101010101010101010000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
